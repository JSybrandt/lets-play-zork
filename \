import { Component, OnInit, AfterViewInit, ViewChild, ElementRef } from '@angular/core';

import { interval} from 'rxjs';
import { HistItem } from '../histitem';
import { GameService } from '../game.service';

import { CdkVirtualScrollViewport } from '@angular/cdk/scrolling';


@Component({
  selector: 'app-game',
  templateUrl: './game.component.html',
  styleUrls: ['./game.component.scss']
})
export class GameComponent implements OnInit, AfterViewInit {
  command: string = "";
  history: HistItem[] = [];
  waiting: boolean = false;

  constructor(
    private gameService: GameService
  ) { }

  ngOnInit(): void {
    this.gameService.get_history().subscribe(h => this.updateHistory(h));
    interval(3000).subscribe(()=>{
      this.gameService.get_history().subscribe(h => this.updateHistory(h));
    });
  }

  ngAfterViewInit(): void {
  }

  submit(): void {
    if(!this.commandIsValid()) return;
    this.gameService.send_command(this.command).subscribe(hist => {
      this.updateHistory(hist);
      this.waiting = false;
    });
    this.waiting = true;
    this.command = "";
  }



  updateHistory(history:HistItem[]): void {
    this.history = history;
    this.scrollToBottom();
  }

  commandIsValid(): boolean {
    return !this.waiting && this.command.length > 0 && this.command.length <= 200;
  }

  getCardClass(item: HistItem): string {
    if(item.command) return "command";
    if(item.prompt) return "prompt";
    if(item.error) return "error";
    return "error"
  }

  histItemToString(item: HistItem): string {
    if(item.command) return item.command;
    if(item.prompt) return item.prompt;
    if(item.error) return item.error;
    return "Invalid Item"
  }

  @ViewChild("viewport") private viewportContainer!: CdkVirtualScrollViewport;
  scrollToBottom(){
    let size = this.viewportContainer.measureRenderedContentSize();
    this.viewportContainer.scrollToOffset(size, "smooth");
  }

}
